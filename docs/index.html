<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Practica12</title><meta name="description" content="Documentation for Practica12"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os"</script><header class="tsd-page-toolbar">
<div class="tsd-toolbar-contents container">
<div class="table-cell" id="tsd-search" data-base=".">
<div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M15.7824 13.833L12.6666 10.7177C12.5259 10.5771 12.3353 10.499 12.1353 10.499H11.6259C12.4884 9.39596 13.001 8.00859 13.001 6.49937C13.001 2.90909 10.0914 0 6.50048 0C2.90959 0 0 2.90909 0 6.49937C0 10.0896 2.90959 12.9987 6.50048 12.9987C8.00996 12.9987 9.39756 12.4863 10.5008 11.6239V12.1332C10.5008 12.3332 10.5789 12.5238 10.7195 12.6644L13.8354 15.7797C14.1292 16.0734 14.6042 16.0734 14.8948 15.7797L15.7793 14.8954C16.0731 14.6017 16.0731 14.1267 15.7824 13.833ZM6.50048 10.499C4.29094 10.499 2.50018 8.71165 2.50018 6.49937C2.50018 4.29021 4.28781 2.49976 6.50048 2.49976C8.71001 2.49976 10.5008 4.28708 10.5008 6.49937C10.5008 8.70852 8.71314 10.499 6.50048 10.499Z" fill="var(--color-text)"></path></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div>
<div class="field">
<div id="tsd-toolbar-links"></div></div>
<ul class="results">
<li class="state loading">Preparing search index...</li>
<li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">Practica12</a></div>
<div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="7" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="11" width="14" height="2" fill="var(--color-text)"></rect></svg></a></div></div></header>
<div class="container container-main">
<div class="col-8 col-content">
<div class="tsd-page-title">
<h2>Practica12</h2></div>
<div class="tsd-panel tsd-typography">
<a href="#práctica-12---destravate-api-nodeexpress" id="práctica-12---destravate-api-nodeexpress" style="color: inherit; text-decoration: none;">
  <h1>Práctica 12 - Destravate: API Node/Express</h1>
</a>

<a href="#desarollado-por-facundo-garcía-gallo-y-daniel-felipe-gómez" id="desarollado-por-facundo-garcía-gallo-y-daniel-felipe-gómez" style="color: inherit; text-decoration: none;">
  <h2>Desarollado por Facundo García Gallo y Daniel Felipe Gómez</h2>
</a>
<p align="center">
  <a href="https://github.com/ULL-ESIT-INF-DSI-2223/ull-esit-inf-dsi-22-23-prct12-destravate-api-grupom/actions/workflows/node.js.yml">
    <img alt="Tests" src="https://github.com/ULL-ESIT-INF-DSI-2223/ull-esit-inf-dsi-22-23-prct12-destravate-api-grupom/actions/workflows/node.js.yml/badge.svg">
  </a>
  <a href="https://github.com/ULL-ESIT-INF-DSI-2223/ull-esit-inf-dsi-22-23-prct12-destravate-api-grupom/actions/workflows/coveralls.yml">
    <img alt="Coveralls" src="https://github.com/ULL-ESIT-INF-DSI-2223/ull-esit-inf-dsi-22-23-prct12-destravate-api-grupom/actions/workflows/coveralls.yml/badge.svg">
  </a>
  <a href="https://github.com/ULL-ESIT-INF-DSI-2223/ull-esit-inf-dsi-22-23-prct12-destravate-api-grupom/actions/workflows/sonarcloud.yml">
    <img alt="Sonar-Cloud" src="https://github.com/ULL-ESIT-INF-DSI-2223/ull-esit-inf-dsi-22-23-prct12-destravate-api-grupom/actions/workflows/sonarcloud.yml/badge.svg">
  </a>
</p>


<a href="#indice" id="indice" style="color: inherit; text-decoration: none;">
  <h2>Indice</h2>
</a>
<ul>
<li><p><a href="#introducci%C3%B3n">Introducción</a></p>
</li>
<li><p><a href="#pasos-previos">Pasos previos</a></p>
</li>
<li><p><a href="#idea-general">Idea General</a></p>
</li>
<li><p><a href="#estructura-del-proyecto">Estructura del proyecto</a></p>
</li>
<li><p><a href="#models">Models</a></p>
</li>
<li><p><a href="#routes">Routers</a></p>
</li>
<li><p><a href="#tools">Tools</a></p>
</li>
<li><p><a href="#types">Types</a></p>
</li>
<li><p><a href="#tests">Tests</a></p>
</li>
<li><p><a href="#documentaci%C3%B3n">Documentación</a></p>
</li>
<li><p><a href="#conclusiones">Conclusiones</a></p>
</li>
<li><p><a href="#referencias">Referencias</a></p>
</li>
</ul>

<a href="#introducción" id="introducción" style="color: inherit; text-decoration: none;">
  <h2>Introducción</h2>
</a>
<p>Para la última práctica de la asignatura de Desarrollo de Sistemas Informáticos, se nos solicita implementar una API REST con Node.js y Express. Esta API debe ser capaz de gestionar una base de datos de 4 modelos diferentes los cuales componen una aplicación de rutas en bicicleta o corriendo, los modelos son los siguientes:</p>
<ul>
<li><p><strong>User</strong> - Usuarios de la aplicación</p>
</li>
<li><p><strong>Track</strong> - Rutas de los usuarios</p>
</li>
<li><p><strong>Challenge</strong> - Retos de los usuarios</p>
</li>
<li><p><strong>Group</strong> - Grupos de usuarios</p>
</li>
</ul>
<p>Las relaciones y elementos que componen a los modelos se corresponde a la ya trabajada en la anterior práctica de grupo. Sin embargo, más adelante se expondrán nuevamente.</p>
<p>Para la gestión de la base de datos se ha utilizado <strong>MongoDB</strong> y <strong>Mongoose</strong>. Además como ya se acostumbra se hará uso de <strong>Mocha</strong> y <strong>Chai</strong> para la realización de los tests, y se utilizará <strong>Sonar Cloud</strong> para la comprobación de la calidad del código.</p>

<a href="#pasos-previos" id="pasos-previos" style="color: inherit; text-decoration: none;">
  <h2>Pasos previos</h2>
</a>
<p>Antes de enfrentar la realización de la práctica debemos tener instaladas las correspondientes herramientas. Para ello, se recomienda revisar los <a href="https://ull-esit-inf-dsi-2223.github.io/nodejs-theory/nodejs-mongodb.html">apuntes referentes a MongoDB</a> donde se explica como instalar y configurar MongoDB. También sería comveniente revisar los <a href="https://ull-esit-inf-dsi-2223.github.io/nodejs-theory/nodejs-mongoose.html">apuntes referentes a Mongoose</a> donde se explica como instalar y configurar Mongoose.</p>
<p>Por último para el desarrollo de la API podemos apoyarnos de los <a href="https://ull-esit-inf-dsi-2223.github.io/nodejs-theory/nodejs-rest-api.html">apuntes referentes a el desarrollo de API REST</a> donde se explica como desarrollar una API REST con Node.js y Express.</p>

<a href="#idea-general" id="idea-general" style="color: inherit; text-decoration: none;">
  <h2>Idea General</h2>
</a>
<p>Para el desarrollo de la API definiremos los esquemas correspondeintes a cada uno de las entidades que pretendemos modelar en la base de datos y crearemos una colección para cada una. Debemos tener presente que pretendemos que la API sea capaz de gestionar los siguientes modelos y sus correspondientes operaciones en la base de datos:</p>
<ul>
<li><p><strong>User</strong> - Usuarios de la aplicación</p>
<ul>
<li>Crear un usuario</li>
<li>Obtener todos los usuarios</li>
<li>Obtener un usuario por su username</li>
<li>Actualizar un usuario por su username</li>
<li>Eliminar un usuario por su username</li>
</ul>
</li>
<li><p><strong>Track</strong> - Rutas de los usuarios</p>
<ul>
<li>Crear una ruta</li>
<li>Obtener todas las rutas</li>
<li>Obtener una ruta por su id</li>
<li>Actualizar una ruta por su id</li>
<li>Eliminar una ruta por su id</li>
</ul>
</li>
<li><p><strong>Challenge</strong> - Retos de los usuarios</p>
<ul>
<li>Crear un reto</li>
<li>Obtener todos los retos</li>
<li>Obtener un reto por su id</li>
<li>Actualizar un reto por su id</li>
<li>Eliminar un reto por su id</li>
</ul>
</li>
<li><p><strong>Group</strong> - Grupos de usuarios</p>
<ul>
<li>Crear un grupo</li>
<li>Obtener todos los grupos</li>
<li>Obtener un grupo por su id</li>
<li>Actualizar un grupo por su id</li>
<li>Eliminar un grupo por su id</li>
</ul>
</li>
</ul>
<p>En el siguiente apartado se explicará la estructura del proyecto y como se ha implementado cada uno de los modelos y sus correspondientes operaciones.</p>

<a href="#estructura-del-proyecto" id="estructura-del-proyecto" style="color: inherit; text-decoration: none;">
  <h2>Estructura del proyecto</h2>
</a>
<p>A medida que el proyecto crecía nos dimos cuenta que la modularidad sería un factor imprescindible para poder mantener el código de una forma ordenada y limpia. Por ello, decidimos separar el código en diferentes carpetas y archivos. A continuación se explicará la estructura del proyecto y el contenido de cada uno de los archivos.</p>
<pre><code><span class="hl-0">.</span><span class="hl-1">src</span><br/><span class="hl-0">├── </span><span class="hl-1">app</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">├── </span><span class="hl-1">server</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">├── </span><span class="hl-1">db</span><br/><span class="hl-0">│   └── </span><span class="hl-1">mongoose</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">├── </span><span class="hl-1">models</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">challengeModel</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">groupModel</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">trackModel</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   └── </span><span class="hl-1">userModel</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">├── </span><span class="hl-1">routers</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">challengeRouter</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">groupRouter</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">trackRouter</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">user</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">get</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">post</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">patch</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   └── </span><span class="hl-1">delete</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">track</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">get</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">post</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">patch</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   └── </span><span class="hl-1">delete</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   ├── </span><span class="hl-1">challenge</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">get</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">post</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   ├── </span><span class="hl-1">patch</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   │   └── </span><span class="hl-1">delete</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│   └── </span><span class="hl-1">group</span><br/><span class="hl-0">│       ├── </span><span class="hl-1">get</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│       ├── </span><span class="hl-1">post</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│       ├── </span><span class="hl-1">patch</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">│       └── </span><span class="hl-1">delete</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">├── </span><span class="hl-1">tools</span><br/><span class="hl-0">│   └── </span><span class="hl-1">tools</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">└── </span><span class="hl-1">types</span><br/><span class="hl-0">    └── </span><span class="hl-1">types</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">.</span><span class="hl-1">test</span><br/><span class="hl-0">└── </span><span class="hl-1">routers</span><br/><span class="hl-0">    ├── </span><span class="hl-1">challengeRouter</span><span class="hl-0">.</span><span class="hl-1">spec</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">    ├── </span><span class="hl-1">groupRouter</span><span class="hl-0">.</span><span class="hl-1">spec</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">    ├── </span><span class="hl-1">trackRouter</span><span class="hl-0">.</span><span class="hl-1">spec</span><span class="hl-0">.</span><span class="hl-1">ts</span><br/><span class="hl-0">    └── </span><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-1">spec</span><span class="hl-0">.</span><span class="hl-1">ts</span>
</code></pre>
<p>Para conseguir la división de los verbos HTTP en ficheros fue todo un reto debido a que se debe indicar en su correrpondiente fichero <strong>router</strong> que existe un controlador para determinada operación. Por ejemplo, en el fichero <strong>userRouter.ts</strong> se indica que existe un controlador para la operación GET, POST, PATCH y DELETE. Para ello, se ha utilizado el siguiente código:</p>
<pre><code class="language-typescript"><span class="hl-2">// src/routers/userRouter.ts</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">post</span><span class="hl-0">(</span><span class="hl-4">&quot;/users&quot;</span><span class="hl-0">, </span><span class="hl-1">postUser</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">get</span><span class="hl-0">(</span><span class="hl-4">&quot;/users&quot;</span><span class="hl-0">, </span><span class="hl-1">getUserQuery</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">get</span><span class="hl-0">(</span><span class="hl-4">&quot;/users/:username&quot;</span><span class="hl-0">, </span><span class="hl-1">getUser</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">patch</span><span class="hl-0">(</span><span class="hl-4">&quot;/users&quot;</span><span class="hl-0">, </span><span class="hl-1">patchUserQuery</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">patch</span><span class="hl-0">(</span><span class="hl-4">&quot;/users/:username&quot;</span><span class="hl-0">, </span><span class="hl-1">patchUser</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">delete</span><span class="hl-0">(</span><span class="hl-4">&quot;/users&quot;</span><span class="hl-0">, </span><span class="hl-1">deleteUserQuery</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">delete</span><span class="hl-0">(</span><span class="hl-4">&quot;/users/:username&quot;</span><span class="hl-0">, </span><span class="hl-1">deleteUser</span><span class="hl-0">)</span>
</code></pre>
<p>Como podemos ver definimos la ruta y el controlador que se ejecutará en cada una de las operaciones. Unos apartados más adelante se explicará como se ha implementado cada uno de los controladores.</p>

<a href="#models" id="models" style="color: inherit; text-decoration: none;">
  <h2>Models</h2>
</a>
<p>En el correspondiente dichero de un modelo se define el esquema que tendrá la colección en la base de datos. Para ello, se ha utilizado la librería <strong>Mongoose</strong>. Además para añadir el control de el tipado creamos una interfaz que se corresponde con el esquema de la colección y la cual extiende de Document de Mongoose. A continuación se muestra un ejemplo de un modelo:</p>
<pre><code class="language-typescript"><span class="hl-2">// src/models/userModel.ts</span><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">interface</span><span class="hl-0"> </span><span class="hl-7">ChallengeDocumentInterface</span><span class="hl-0"> </span><span class="hl-6">extends</span><span class="hl-0"> </span><span class="hl-7">Document</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-1">id</span><span class="hl-0">: </span><span class="hl-7">number</span><span class="hl-0">;</span><br/><span class="hl-0">  </span><span class="hl-1">name</span><span class="hl-0">: </span><span class="hl-7">string</span><span class="hl-0">;</span><br/><span class="hl-0">  </span><span class="hl-1">tracks</span><span class="hl-0">: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">[];</span><br/><span class="hl-0">  </span><span class="hl-1">activity</span><span class="hl-0">: </span><span class="hl-4">&quot;Bicicleta&quot;</span><span class="hl-0"> | </span><span class="hl-4">&quot;Correr&quot;</span><span class="hl-0">;</span><br/><span class="hl-0">  </span><span class="hl-1">totalDistance</span><span class="hl-0">?: </span><span class="hl-7">number</span><span class="hl-0">;</span><br/><span class="hl-0">  </span><span class="hl-1">users</span><span class="hl-0">?: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">[];</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">ChallengeSchema</span><span class="hl-0"> = </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Schema</span><span class="hl-0">&lt;</span><span class="hl-7">ChallengeDocumentInterface</span><span class="hl-0">&gt;({</span><br/><span class="hl-0">  </span><span class="hl-1">id:</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-1">type:</span><span class="hl-0"> </span><span class="hl-1">Number</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">unique:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">required:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">,</span><br/><span class="hl-0">  },</span><br/><span class="hl-0">  </span><span class="hl-1">name:</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-1">type:</span><span class="hl-0"> </span><span class="hl-1">String</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">required:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">trim:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">unique:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-3">validate</span><span class="hl-1">:</span><span class="hl-0"> (</span><span class="hl-1">value</span><span class="hl-0">: </span><span class="hl-7">string</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">      </span><span class="hl-5">if</span><span class="hl-0"> (!</span><span class="hl-1">value</span><span class="hl-0">.</span><span class="hl-3">match</span><span class="hl-0">(</span><span class="hl-9">/</span><span class="hl-10">^</span><span class="hl-11">[</span><span class="hl-9">A-Z</span><span class="hl-11">]</span><span class="hl-9">/</span><span class="hl-0">)) {</span><br/><span class="hl-0">        </span><span class="hl-5">throw</span><span class="hl-0"> </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Error</span><span class="hl-0">(</span><span class="hl-4">&quot;El nombre de un reto debe comenzar con mayúscula&quot;</span><span class="hl-0">);</span><br/><span class="hl-0">      } </span><span class="hl-5">else</span><span class="hl-0"> </span><span class="hl-5">if</span><span class="hl-0"> (!</span><span class="hl-1">validator</span><span class="hl-0">.</span><span class="hl-1">default</span><span class="hl-0">.</span><span class="hl-3">isAlphanumeric</span><span class="hl-0">(</span><span class="hl-1">value</span><span class="hl-0">)) {</span><br/><span class="hl-0">        </span><span class="hl-5">throw</span><span class="hl-0"> </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Error</span><span class="hl-0">(</span><span class="hl-4">&quot;Solo se aceptan caracteres alfanuméricos&quot;</span><span class="hl-0">);</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    },</span><br/><span class="hl-0">  },</span><br/><span class="hl-0">  </span><span class="hl-1">tracks:</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-1">type:</span><span class="hl-0"> [</span><span class="hl-1">Schema</span><span class="hl-0">.</span><span class="hl-1">Types</span><span class="hl-0">.</span><span class="hl-1">ObjectId</span><span class="hl-0">],</span><br/><span class="hl-0">    </span><span class="hl-1">required:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">ref:</span><span class="hl-0"> </span><span class="hl-4">&quot;Track&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-3">validate</span><span class="hl-1">:</span><span class="hl-0"> </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">value</span><span class="hl-0">: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">[]) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0"> (</span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">id</span><span class="hl-0"> </span><span class="hl-6">of</span><span class="hl-0"> </span><span class="hl-1">value</span><span class="hl-0">) {</span><br/><span class="hl-0">        </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-3">TracksExist</span><span class="hl-0">(</span><span class="hl-1">id</span><span class="hl-0">);</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">  },</span><br/><span class="hl-0">  </span><span class="hl-1">activity:</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-1">type:</span><span class="hl-0"> </span><span class="hl-1">String</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">required:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">enum:</span><span class="hl-0"> [</span><span class="hl-4">&quot;Correr&quot;</span><span class="hl-0">, </span><span class="hl-4">&quot;Bicicleta&quot;</span><span class="hl-0">],</span><br/><span class="hl-0">  },</span><br/><span class="hl-0">  </span><span class="hl-1">totalDistance:</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-1">type:</span><span class="hl-0"> </span><span class="hl-1">Number</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">default:</span><span class="hl-0"> </span><span class="hl-12">0</span><span class="hl-0">,</span><br/><span class="hl-0">  },</span><br/><span class="hl-0">  </span><span class="hl-1">users:</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-1">type:</span><span class="hl-0"> [</span><span class="hl-1">Schema</span><span class="hl-0">.</span><span class="hl-1">Types</span><span class="hl-0">.</span><span class="hl-1">ObjectId</span><span class="hl-0">],</span><br/><span class="hl-0">    </span><span class="hl-1">ref:</span><span class="hl-0"> </span><span class="hl-4">&quot;User&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">    </span><span class="hl-1">default:</span><span class="hl-0"> [],</span><br/><span class="hl-0">    </span><span class="hl-3">validate</span><span class="hl-1">:</span><span class="hl-0"> </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">value</span><span class="hl-0">: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">[]) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0"> (</span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">id</span><span class="hl-0"> </span><span class="hl-6">of</span><span class="hl-0"> </span><span class="hl-1">value</span><span class="hl-0">) {</span><br/><span class="hl-0">        </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-3">UsersExist</span><span class="hl-0">(</span><span class="hl-1">id</span><span class="hl-0">);</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">  },</span><br/><span class="hl-0">});</span>
</code></pre>
<p>Como podemos ver la interfaz que definimos debemos procurar añadir todos los elementos necesarios en el esquema de Mongoose para que se correspondan entre si. Además, podemos añadir validaciones para los campos que necesitemos. En este caso, hemos añadido validaciones para el campo <strong>name</strong> y <strong>tracks</strong>. Para el campo <strong>name</strong> hemos añadido una validación para que el nombre comience con mayúscula y solo se acepten caracteres alfanuméricos. Para el campo <strong>tracks</strong> hemos añadido una validación para comprobar que los ids de las rutas existen en la base de datos. Para ello, hemos creado una función que comprueba si existe una ruta con el id que le pasamos como parámetro. En caso de que no exista lanza un error. A continuación se muestra el código de la función:</p>
<pre><code class="language-typescript"><span class="hl-2">// src/tools/tools.ts</span><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">TracksExist</span><span class="hl-0"> = </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">id</span><span class="hl-0">: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">tracks</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Track</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">id</span><span class="hl-0"> });</span><br/><span class="hl-0">  </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">tracks</span><span class="hl-0"> === </span><span class="hl-6">null</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">throw</span><span class="hl-0"> </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Error</span><span class="hl-0">(</span><span class="hl-4">&#39;No existe ninguna ruta con ese id&#39;</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">  </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">;</span><br/><span class="hl-0">};</span>
</code></pre>
<p>En la función nos encargamos, mediante una consulta a la base de datos de Track, de comprobar que existe el <strong>id</strong> pasado como parámetro y en caso de que no exista lanzamos un error. En caso de que exista devolvemos <strong>true</strong>. De esta forma, podemos añadir la validación en el campo <strong>tracks</strong> del esquema de Mongoose.</p>

<a href="#routers" id="routers" style="color: inherit; text-decoration: none;">
  <h2>Routers</h2>
</a>
<p>Como ya se menciono en apartados anteriores, hemos realizado una modulación total de los verbos de cada modelo para permitir mejor mantenimiento del código y permitir que sea escalable. Si nos centramos entonces en cada una de las operaciones, tomaremos <strong>User</strong> como referencia. En el fichero <strong>userRouter.ts</strong> se definen las rutas y los controladores que se ejecutarán en cada una de las operaciones. A continuación se muestra el código:</p>
<pre><code class="language-typescript"><span class="hl-2">// src/routers/userRouter.ts</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">post</span><span class="hl-0">(</span><span class="hl-4">&quot;/users&quot;</span><span class="hl-0">, </span><span class="hl-1">postUser</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">get</span><span class="hl-0">(</span><span class="hl-4">&quot;/users&quot;</span><span class="hl-0">, </span><span class="hl-1">getUserQuery</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">get</span><span class="hl-0">(</span><span class="hl-4">&quot;/users/:username&quot;</span><span class="hl-0">, </span><span class="hl-1">getUser</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">patch</span><span class="hl-0">(</span><span class="hl-4">&quot;/users&quot;</span><span class="hl-0">, </span><span class="hl-1">patchUserQuery</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">patch</span><span class="hl-0">(</span><span class="hl-4">&quot;/users/:username&quot;</span><span class="hl-0">, </span><span class="hl-1">patchUser</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">delete</span><span class="hl-0">(</span><span class="hl-4">&quot;/users&quot;</span><span class="hl-0">, </span><span class="hl-1">deleteUserQuery</span><span class="hl-0">)</span><br/><span class="hl-1">userRouter</span><span class="hl-0">.</span><span class="hl-3">delete</span><span class="hl-0">(</span><span class="hl-4">&quot;/users/:username&quot;</span><span class="hl-0">, </span><span class="hl-1">deleteUser</span><span class="hl-0">)</span>
</code></pre>
<p>Veamos entonces como se ha implementado cada uno de los routers.</p>

<a href="#post" id="post" style="color: inherit; text-decoration: none;">
  <h3>POST</h3>
</a>
<pre><code class="language-typescript"><span class="hl-2">// src/routers/user/post.ts	</span><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">postUser</span><span class="hl-0"> = </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">req</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">, </span><span class="hl-1">res</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-5">try</span><span class="hl-0"> {</span><br/><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">user</span><span class="hl-0"> = </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">User</span><span class="hl-0">(</span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">);</span><br/><span class="hl-0">  </span><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados los usuarios de rutas, con las rutas de usuarios</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">values</span><span class="hl-0"> = [...</span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Set</span><span class="hl-0">([...(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0">.</span><span class="hl-3">values</span><span class="hl-0">())].</span><span class="hl-3">flat</span><span class="hl-0">())];</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0"> (</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">values</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Track</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">values</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">] }, { </span><span class="hl-1">$addToSet:</span><span class="hl-0"> { </span><span class="hl-1">users:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">  </span><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados los ususarios con los grupos y los grupos con los usuarios</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friendsGroups</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0">(</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friendsGroups</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Group</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friendsGroups</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">] }, { </span><span class="hl-1">$addToSet:</span><span class="hl-0"> { </span><span class="hl-1">participants:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">  </span><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados los amigos de un usuario</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friends</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0">(</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friends</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friends</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">] }, { </span><span class="hl-1">$addToSet:</span><span class="hl-0"> { </span><span class="hl-1">friends:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">    </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-3">save</span><span class="hl-0">();</span><br/><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: las estadísticas del usuario</span><br/><span class="hl-0">    </span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">estadisticas</span><span class="hl-0">: </span><span class="hl-7">Stats</span><span class="hl-0"> = [[</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">],[</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">],[</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">]]</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">rutas</span><span class="hl-0"> = </span><span class="hl-1">Array</span><span class="hl-0">.</span><span class="hl-3">from</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0">.</span><span class="hl-3">values</span><span class="hl-0">()).</span><span class="hl-3">flat</span><span class="hl-0">();</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0">(</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">rutas</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">ruta</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Track</span><span class="hl-0">.</span><span class="hl-3">findById</span><span class="hl-0">(</span><span class="hl-1">rutas</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">]);</span><br/><span class="hl-0">        </span><span class="hl-5">if</span><span class="hl-0">(</span><span class="hl-1">ruta</span><span class="hl-0"> !== </span><span class="hl-6">null</span><span class="hl-0">) {</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">0</span><span class="hl-0">][</span><span class="hl-12">0</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">unevenness</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">0</span><span class="hl-0">][</span><span class="hl-12">1</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">distance</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">1</span><span class="hl-0">][</span><span class="hl-12">0</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">unevenness</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">1</span><span class="hl-0">][</span><span class="hl-12">1</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">distance</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">2</span><span class="hl-0">][</span><span class="hl-12">0</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">unevenness</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">2</span><span class="hl-0">][</span><span class="hl-12">1</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">distance</span><span class="hl-0">;</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">    </span><br/><span class="hl-0">    </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findByIdAndUpdate</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> , { </span><span class="hl-1">trainingStats:</span><span class="hl-0"> </span><span class="hl-1">estadisticas</span><span class="hl-0"> });</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">userActualizado</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findById</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0">);</span><br/><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">201</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">userActualizado</span><span class="hl-0">);</span><br/><span class="hl-0">  } </span><span class="hl-5">catch</span><span class="hl-0"> (</span><span class="hl-1">error</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">500</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">({</span><span class="hl-1">msg:</span><span class="hl-0"> </span><span class="hl-4">&quot;No se añadió correctamente el usuario&quot;</span><span class="hl-0">, </span><span class="hl-1">error:</span><span class="hl-0"> </span><span class="hl-1">error</span><span class="hl-0">});</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">};</span>
</code></pre>
<p>Como podemos ver se define el controlador asíncrono <strong>postUser</strong> que se encarga de añadir un usuario a la base de datos. Para ello, se crea un objeto de tipo <strong>User</strong> con los datos que se le pasan en el cuerpo de la petición. A continuación, se comprueba si el usuario tiene rutas en su historial, en caso de que tenga se actualizan las rutas para que apunten al usuario. De igual forma, se comprueba si el usuario tiene grupos de amigos, en caso de que tenga se actualizan los grupos para que apunten al usuario. Se comprueba si el usuario tiene amigos, en caso de que tenga se actualizan los amigos para que apunten al usuario. </p>
<p>Por último, se actualiza las estadísticas del usuario. Una vez se han actualizado todos los datos se guarda el usuario en la base de datos y se devuelve el usuario actualizado.</p>
<p><strong>IMPORTANTE -&gt;</strong> Con las correspondientes verificaciones que se realizan para mantener al usuario actualizado nos aseguramos de la integridad de los datos en todos los modelos que se relacionan con el modelo <strong>User</strong>.</p>

<a href="#get" id="get" style="color: inherit; text-decoration: none;">
  <h3>GET</h3>
</a>
<p>Para el método <strong>GET</strong> se han definido dos formas de obtener los usuarios. La primera froma se basa en querys y la segunda forma se basa en parámetros de la ruta. A continuación se muestra el código de ambas formas:</p>
<pre><code class="language-typescript"><span class="hl-2">// src/routers/user/get.ts</span><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">getUserQuery</span><span class="hl-0"> =  </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">req</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">, </span><span class="hl-1">res</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-5">try</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">filter</span><span class="hl-0"> = </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0"> ? {</span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0">.</span><span class="hl-3">toString</span><span class="hl-0">()} : {};</span><br/><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">users</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">find</span><span class="hl-0">(</span><span class="hl-1">filter</span><span class="hl-0">);</span><br/><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">users</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0"> !== </span><span class="hl-12">0</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">200</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">users</span><span class="hl-0">);</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">404</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">();</span><br/><span class="hl-0">  } </span><span class="hl-5">catch</span><span class="hl-0"> (</span><span class="hl-1">error</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">500</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">error</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">};</span><br/><br/><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">getUser</span><span class="hl-0"> =  </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">req</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">, </span><span class="hl-1">res</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><br/><span class="hl-0">  </span><span class="hl-5">try</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">filter</span><span class="hl-0"> = </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">params</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0"> ? {</span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">params</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0">.</span><span class="hl-3">toString</span><span class="hl-0">()} : {};</span><br/><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">users</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">find</span><span class="hl-0">(</span><span class="hl-1">filter</span><span class="hl-0">);</span><br/><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">users</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0"> !== </span><span class="hl-12">0</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">200</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">users</span><span class="hl-0">);</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">404</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">();</span><br/><span class="hl-0">  } </span><span class="hl-5">catch</span><span class="hl-0"> (</span><span class="hl-1">error</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">500</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">error</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">};</span>
</code></pre>
<p>Como podemos ver, en ambos casos se define un controlador asíncrono que se encarga de obtener los usuarios de la base de datos. En el caso de <strong>getUserQuery</strong> se obtienen los usuarios que coincidan con el nombre de usuario que se pasa en la query. En el caso de <strong>getUser</strong> se obtienen los usuarios que coincidan con el nombre de usuario que se pasa en la ruta. En ambos casos se devuelve un array con los usuarios que coincidan con el filtro. Para controlar la posibilidad de solicitud de todos los usuarios usamos un operados ternario en el filtro, donde en caso de no definirse ningún <strong>username</strong> se devuelve un objeto vacío, de esta forma se obtienen todos los usuarios.</p>

<a href="#patch" id="patch" style="color: inherit; text-decoration: none;">
  <h3>PATCH</h3>
</a>
<p>Nuevamente hemos desarrollado dos formas de actualizar los usuarios. La primera forma se basa en querys y la segunda forma se basa en parámetros de la ruta. Sin embargo, para simplificar la explicación expondremos una sola en el informe, ya que ambas son muy similares.</p>
<pre><code class="language-typescript"><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">patchUserQuery</span><span class="hl-0"> =  </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">req</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">, </span><span class="hl-1">res</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-5">if</span><span class="hl-0"> (!</span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">400</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">({ </span><span class="hl-1">error:</span><span class="hl-0"> </span><span class="hl-4">&#39;A username must be provided&#39;</span><span class="hl-0"> });</span><br/><span class="hl-0">  }</span><br/><br/><span class="hl-0">  </span><span class="hl-5">try</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">allowedUpdates</span><span class="hl-0"> = [</span><span class="hl-4">&quot;name&quot;</span><span class="hl-0">, </span><span class="hl-4">&quot;activity&quot;</span><span class="hl-0">, </span><span class="hl-4">&quot;friends&quot;</span><span class="hl-0">, </span><span class="hl-4">&quot;friendsGroups&quot;</span><span class="hl-0">, </span><span class="hl-4">&quot;history&quot;</span><span class="hl-0">];</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">actualUpdates</span><span class="hl-0"> = </span><span class="hl-1">Object</span><span class="hl-0">.</span><span class="hl-3">keys</span><span class="hl-0">(</span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">);</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">isValidUpdate</span><span class="hl-0"> = </span><span class="hl-1">actualUpdates</span><span class="hl-0">.</span><span class="hl-3">every</span><span class="hl-0">((</span><span class="hl-1">update</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> </span><span class="hl-1">allowedUpdates</span><span class="hl-0">.</span><span class="hl-3">includes</span><span class="hl-0">(</span><span class="hl-1">update</span><span class="hl-0">));</span><br/><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (!</span><span class="hl-1">isValidUpdate</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">400</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">({ </span><span class="hl-1">error:</span><span class="hl-0"> </span><span class="hl-4">&quot;Los parámetros seleccionados no se puede modificar&quot;</span><span class="hl-0">});</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    </span><span class="hl-2">// Usuario antes de ser modificado</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">userActual</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({ </span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0"> });</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">arrayGruposAntes</span><span class="hl-0"> = </span><span class="hl-1">userActual</span><span class="hl-0">?.</span><span class="hl-1">friendsGroups</span><span class="hl-0">;</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">arrayAmigosAntes</span><span class="hl-0"> = </span><span class="hl-1">userActual</span><span class="hl-0">?.</span><span class="hl-1">friends</span><span class="hl-0">;</span><br/><br/><span class="hl-0">    </span><span class="hl-2">// Usuario después de ser modificado</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">user</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0"> }, </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">, { </span><span class="hl-1">new:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">, </span><span class="hl-1">runValidators:</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">, });</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">arrayGruposDespues</span><span class="hl-0"> = </span><span class="hl-1">user</span><span class="hl-0">?.</span><span class="hl-1">friendsGroups</span><span class="hl-0">;</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">arrayAmigosDespues</span><span class="hl-0"> = </span><span class="hl-1">user</span><span class="hl-0">?.</span><span class="hl-1">friends</span><span class="hl-0">;</span><br/><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados el atributo friendsGroups de los usuarios</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">arrayGruposAntes</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0"> &amp;&amp; </span><span class="hl-1">arrayGruposDespues</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0"> &amp;&amp; </span><span class="hl-1">user</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">diferenciaGrupos</span><span class="hl-0"> = </span><span class="hl-1">arrayGruposAntes</span><span class="hl-0">.</span><span class="hl-3">filter</span><span class="hl-0">((</span><span class="hl-1">group</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> !</span><span class="hl-1">arrayGruposDespues</span><span class="hl-0">.</span><span class="hl-3">includes</span><span class="hl-0">(</span><span class="hl-1">group</span><span class="hl-0">));</span><br/><span class="hl-0">      </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">diferenciaGrupos</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0"> !== </span><span class="hl-12">0</span><span class="hl-0">) {</span><br/><span class="hl-0">        </span><span class="hl-5">for</span><span class="hl-0">(</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">diferenciaGrupos</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; ++</span><span class="hl-1">i</span><span class="hl-0">) {</span><br/><span class="hl-0">          </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Group</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">diferenciaGrupos</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">] }, { </span><span class="hl-1">$pull:</span><span class="hl-0"> { </span><span class="hl-1">participants:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados el atributo friends de los usuarios</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">arrayAmigosAntes</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0"> &amp;&amp; </span><span class="hl-1">arrayAmigosDespues</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0"> &amp;&amp; </span><span class="hl-1">user</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">diferenciaAmigos</span><span class="hl-0"> = </span><span class="hl-1">arrayAmigosAntes</span><span class="hl-0">.</span><span class="hl-3">filter</span><span class="hl-0">((</span><span class="hl-1">friend</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> !</span><span class="hl-1">arrayAmigosDespues</span><span class="hl-0">.</span><span class="hl-3">includes</span><span class="hl-0">(</span><span class="hl-1">friend</span><span class="hl-0">));</span><br/><span class="hl-0">      </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">diferenciaAmigos</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0"> !== </span><span class="hl-12">0</span><span class="hl-0">) {</span><br/><span class="hl-0">        </span><span class="hl-5">for</span><span class="hl-0">(</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">diferenciaAmigos</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; ++</span><span class="hl-1">i</span><span class="hl-0">) {</span><br/><span class="hl-0">          </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">diferenciaAmigos</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">] }, { </span><span class="hl-1">$pull:</span><span class="hl-0"> { </span><span class="hl-1">friends:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados los ususarios de rutas, con las rutas de usuarios</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">user</span><span class="hl-0"> &amp;&amp; </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">values</span><span class="hl-0"> = [...</span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Set</span><span class="hl-0">([...(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0">.</span><span class="hl-3">values</span><span class="hl-0">())].</span><span class="hl-3">flat</span><span class="hl-0">())];</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0"> (</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">values</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Track</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">values</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">] }, { </span><span class="hl-1">$addToSet:</span><span class="hl-0"> { </span><span class="hl-1">users:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">    </span><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados los ususarios con los grupos y los grupos con los usuarios</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0"> &amp;&amp; </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friendsGroups</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0">(</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friendsGroups</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Group</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friendsGroups</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">] }, { </span><span class="hl-1">$addToSet:</span><span class="hl-0"> { </span><span class="hl-1">participants:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">  </span><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados los amigos de un usuario</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0"> &amp;&amp; </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friends</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0">(</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friends</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOneAndUpdate</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">friends</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">] }, { </span><span class="hl-1">$addToSet:</span><span class="hl-0"> { </span><span class="hl-1">friends:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    </span><span class="hl-2">// ACTUALIZA: las estadísticas del usuario</span><br/><span class="hl-0">    </span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">estadisticas</span><span class="hl-0">: </span><span class="hl-7">Stats</span><span class="hl-0"> = [[</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">],[</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">],[</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">]]</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">user</span><span class="hl-0"> &amp;&amp; </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">rutas</span><span class="hl-0"> = </span><span class="hl-1">Array</span><span class="hl-0">.</span><span class="hl-3">from</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0">.</span><span class="hl-3">values</span><span class="hl-0">()).</span><span class="hl-3">flat</span><span class="hl-0">();</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0">(</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">rutas</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">ruta</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Track</span><span class="hl-0">.</span><span class="hl-3">findById</span><span class="hl-0">(</span><span class="hl-1">rutas</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">]);</span><br/><span class="hl-0">        </span><span class="hl-5">if</span><span class="hl-0">(</span><span class="hl-1">ruta</span><span class="hl-0"> !== </span><span class="hl-6">null</span><span class="hl-0">) {</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">0</span><span class="hl-0">][</span><span class="hl-12">0</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">unevenness</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">0</span><span class="hl-0">][</span><span class="hl-12">1</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">distance</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">1</span><span class="hl-0">][</span><span class="hl-12">0</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">unevenness</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">1</span><span class="hl-0">][</span><span class="hl-12">1</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">distance</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">2</span><span class="hl-0">][</span><span class="hl-12">0</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">unevenness</span><span class="hl-0">;</span><br/><span class="hl-0">          </span><span class="hl-1">estadisticas</span><span class="hl-0">[</span><span class="hl-12">2</span><span class="hl-0">][</span><span class="hl-12">1</span><span class="hl-0">] += </span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">distance</span><span class="hl-0">;</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">      </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findByIdAndUpdate</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> , { </span><span class="hl-1">trainingStats:</span><span class="hl-0"> </span><span class="hl-1">estadisticas</span><span class="hl-0"> });</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">    </span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">userActualizado</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({</span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0">});</span><br/><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">userActualizado</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">userActualizado</span><span class="hl-0">);</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">404</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">();</span><br/><span class="hl-0">  } </span><span class="hl-5">catch</span><span class="hl-0"> (</span><span class="hl-1">error</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">500</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">error</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">};</span>
</code></pre>
<p>Primeramente nos aseguramos que se nos proporcione un <strong>username</strong> para poder encontrar un usuario de forma única, posteriormente encerramos dentro de un <strong>try-catch</strong> las correspondientes operaciones.</p>
<p>En la primera parte del código nos encargamos de comprobar que los parámetros que se nos proporcionan para actualizar el usuario son válidos. Para ello, comprobamos que los parámetros que se nos proporcionan se encuentran dentro de un array de parámetros permitidos. En caso de que no sea así, devolvemos un error 400.</p>
<p>Con el fin de mantener sincronizado los datos entre modelos nos encargamos de actualizar el usuario. Para ello, utilizamos la función <strong>findOneAndUpdate</strong> de mongoose. Esta función recibe tres parámetros: el primero es el filtro que se va a aplicar para encontrar el usuario que se quiere actualizar, el segundo es el cuerpo de la petición que contiene los parámetros que se quieren actualizar y el tercero es un objeto que contiene dos parámetros: <strong>new</strong> y <strong>runValidators</strong>. El primero de ellos indica que se devuelva el usuario actualizado y el segundo indica que se ejecuten las validaciones que se han definido en el modelo del usuario.</p>
<p>En la tercera parte del código nos encargamos de mantener sincronizados los atributos <strong>friendsGroups</strong> y <strong>friends</strong> del usuario. Para ello, comprobamos que los atributos antes de ser modificados y los atributos después de ser modificados no son <strong>undefined</strong>. En caso de que no sean <strong>undefined</strong>, comprobamos que los atributos antes de ser modificados y los atributos después de ser modificados no son iguales. En caso de que no sean iguales, se recorre el array de atributos antes de ser modificados y se comprueba que el atributo no se encuentra en el array de atributos después de ser modificados. En caso de que no se encuentre, se recorre el array de atributos antes de ser modificados y se actualizan los atributos de los grupos y de los amigos del usuario.</p>
<p>En la cuarta parte del código nos encargamos de mantener sincronizados los atributos <strong>history</strong> de los usuarios con los atributos <strong>users</strong> de las rutas. Para ello, comprobamos que el usuario no es <strong>undefined</strong> y que el atributo <strong>history</strong> del usuario no es <strong>undefined</strong>. En caso de que no sean <strong>undefined</strong>, se recorre el array de rutas del usuario y se actualizan los atributos <strong>users</strong> de las rutas. </p>
<p>A continuación nos encargamos de mantener sincronizados los atributos <strong>friendsGroups</strong> del usuario con los atributos <strong>participants</strong> de los grupos y los atributos <strong>friends</strong> del usuario con los atributos <strong>friends</strong> de los usuarios. Para ello, comprobamos que el usuario no es <strong>undefined</strong> y que el atributo <strong>friendsGroups</strong> del usuario no es <strong>undefined</strong>. En caso de que no sean <strong>undefined</strong>, se recorre el array de grupos del usuario y se actualizan los atributos <strong>participants</strong> de los grupos y los atributos <strong>friends</strong> de los usuarios.</p>
<p>En la sexta parte del código nos encargamos de actualizar las estadísticas del usuario. Para ello, comprobamos que el usuario no es <strong>undefined</strong> y que el atributo <strong>history</strong> del usuario no es <strong>undefined</strong>. En caso de que no sean <strong>undefined</strong>, se recorre el array de rutas del usuario y se actualizan las estadísticas del usuario.</p>
<p>Finalmente, nos encargamos de devolver el usuario actualizado. Para ello, comprobamos que el usuario no es <strong>undefined</strong>. En caso de que no sea <strong>undefined</strong>, devolvemos el usuario actualizado. En caso de que sea <strong>undefined</strong>, devolvemos un error 404. Es importante asegurarnos que de devolver siempre el usuario con las modificaciones ya realizadas para mantener informado correctamente al cliente de las modificaciones que se han realizado.</p>

<a href="#delete" id="delete" style="color: inherit; text-decoration: none;">
  <h3>DELETE</h3>
</a>
<pre><code class="language-typescript"><span class="hl-2">// src/routers/user/delete.ts</span><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">deleteUserQuery</span><span class="hl-0"> =  </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">req</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">, </span><span class="hl-1">res</span><span class="hl-0">: </span><span class="hl-7">any</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-5">if</span><span class="hl-0"> (!</span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">400</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">({ </span><span class="hl-1">error:</span><span class="hl-0"> </span><span class="hl-4">&#39;A username must be provided&#39;</span><span class="hl-0"> });</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">   </span><span class="hl-5">try</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">user</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({</span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-1">req</span><span class="hl-0">.</span><span class="hl-1">query</span><span class="hl-0">.</span><span class="hl-1">username</span><span class="hl-0">.</span><span class="hl-3">toString</span><span class="hl-0">()});</span><br/><span class="hl-0">     </span><span class="hl-5">if</span><span class="hl-0"> (!</span><span class="hl-1">user</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">404</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">();</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">updateMany</span><span class="hl-0">( { </span><span class="hl-1">friends:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }, { </span><span class="hl-1">$pull:</span><span class="hl-0"> { </span><span class="hl-1">friends:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><br/><span class="hl-0">     </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados los ususarios con los grupos y los grupos con los usuarios</span><br/><span class="hl-0">    </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Group</span><span class="hl-0">.</span><span class="hl-3">updateMany</span><span class="hl-0">({ </span><span class="hl-1">participants:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }, { </span><span class="hl-1">$pull:</span><span class="hl-0"> { </span><span class="hl-1">participants:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><br/><span class="hl-0">     </span><span class="hl-2">// ACTUALIZA: Se encarga de mantener sincronizados los ususarios con los grupos y los grupos con los usuarios</span><br/><span class="hl-0">    </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Challenge</span><span class="hl-0">.</span><span class="hl-3">updateMany</span><span class="hl-0">({ </span><span class="hl-1">users:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }, { </span><span class="hl-1">$pull:</span><span class="hl-0"> { </span><span class="hl-1">users:</span><span class="hl-0"> </span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0"> }});</span><br/><br/><span class="hl-0">    </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findByIdAndDelete</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0">);</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">user</span><span class="hl-0">);</span><br/><span class="hl-0">  } </span><span class="hl-5">catch</span><span class="hl-0"> (</span><span class="hl-1">error</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-1">res</span><span class="hl-0">.</span><span class="hl-3">status</span><span class="hl-0">(</span><span class="hl-12">500</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">(</span><span class="hl-1">error</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">};</span>
</code></pre>
<p>Primeramente nos aseguramos que se nos proporcione un <strong>username</strong> para poder encontrar un usuario de forma única, posteriormente encerramos dentro de un <strong>try-catch</strong> las correspondientes operaciones.</p>
<p>Primeramente obtenemos el usuario que se quiere eliminar. Para ello, utilizamos la función <strong>findOne</strong> de mongoose. Esta función recibe un parámetro que es el filtro que se va a aplicar para encontrar el usuario que se quiere eliminar.</p>
<p>Debemos asegurarnos de borrar el usuario y sus correspondientes apariciones en otros modelos. Para ello, utilizamos la función <strong>updateMany</strong> de mongoose. Esta función recibe dos parámetros: el primero es el filtro que se va a aplicar para encontrar los modelos que se quieren actualizar y el segundo es el cuerpo de la petición que contiene los parámetros que se quieren actualizar. En este caso, se encarga de eliminar el usuario de los atributos <strong>friends</strong> de los usuarios, de los atributos <strong>participants</strong> de los grupos y de los atributos <strong>users</strong> de los retos.</p>

<a href="#tools" id="tools" style="color: inherit; text-decoration: none;">
  <h1>Tools</h1>
</a>
<p>Como ya la expusimos en apartados anteriores, hemos desarrollado un controlador que se encarga de verificar si una determinada <strong>id</strong> pertenece a un modelo de mongoose. </p>
<pre><code class="language-typescript"><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">UsersExist</span><span class="hl-0"> = </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">id</span><span class="hl-0">: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">users</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">id</span><span class="hl-0"> });</span><br/><span class="hl-0">  </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">users</span><span class="hl-0"> === </span><span class="hl-6">null</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">throw</span><span class="hl-0"> </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Error</span><span class="hl-0">(</span><span class="hl-4">&#39;No existe ningún usuario con ese id&#39;</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">  </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">;</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">GroupsExist</span><span class="hl-0"> = </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">id</span><span class="hl-0">: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">groups</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Group</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">id</span><span class="hl-0"> });</span><br/><span class="hl-0">  </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">groups</span><span class="hl-0"> === </span><span class="hl-6">null</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">throw</span><span class="hl-0"> </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Error</span><span class="hl-0">(</span><span class="hl-4">&#39;No existe ningún grupo con ese id&#39;</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">  </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">;</span><br/><span class="hl-0">}</span><br/><br/><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">ChallengesExist</span><span class="hl-0"> = </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">id</span><span class="hl-0">: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">challenge</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Challenge</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">id</span><span class="hl-0"> });</span><br/><span class="hl-0">  </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">challenge</span><span class="hl-0"> === </span><span class="hl-6">null</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">throw</span><span class="hl-0"> </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Error</span><span class="hl-0">(</span><span class="hl-4">&#39;No existe ningún reto con ese id&#39;</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">  </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">;</span><br/><span class="hl-0">}</span><br/><span class="hl-0">  </span><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-3">TracksExist</span><span class="hl-0"> = </span><span class="hl-6">async</span><span class="hl-0"> (</span><span class="hl-1">id</span><span class="hl-0">: </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">tracks</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">Track</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({ </span><span class="hl-1">_id:</span><span class="hl-0"> </span><span class="hl-1">id</span><span class="hl-0"> });</span><br/><span class="hl-0">  </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">tracks</span><span class="hl-0"> === </span><span class="hl-6">null</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-5">throw</span><span class="hl-0"> </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Error</span><span class="hl-0">(</span><span class="hl-4">&#39;No existe ninguna ruta con ese id&#39;</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">  </span><span class="hl-5">return</span><span class="hl-0"> </span><span class="hl-6">true</span><span class="hl-0">;</span><br/><span class="hl-0">}</span>
</code></pre>
<p>En el caso de que no exista ningún modelo con la <strong>id</strong> proporcionada, se lanza un error. En caso contrario, se devuelve <strong>true</strong>.</p>

<a href="#types" id="types" style="color: inherit; text-decoration: none;">
  <h2>Types</h2>
</a>
<p>En este apartado se encuentran los tipos de datos que se utilizan en el proyecto. </p>
<pre><code class="language-typescript"><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">type</span><span class="hl-0"> </span><span class="hl-7">UnevennessDistance</span><span class="hl-0"> = [</span><span class="hl-13">unevenness</span><span class="hl-0">: </span><span class="hl-7">number</span><span class="hl-0">, </span><span class="hl-13">distance</span><span class="hl-0">: </span><span class="hl-7">number</span><span class="hl-0">];</span><br/><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">type</span><span class="hl-0"> </span><span class="hl-7">Stats</span><span class="hl-0"> = [</span><span class="hl-13">week</span><span class="hl-0">: </span><span class="hl-7">UnevennessDistance</span><span class="hl-0">, </span><span class="hl-13">month</span><span class="hl-0">: </span><span class="hl-7">UnevennessDistance</span><span class="hl-0">, </span><span class="hl-13">year</span><span class="hl-0">: </span><span class="hl-7">UnevennessDistance</span><span class="hl-0">];</span><br/><br/><span class="hl-5">export</span><span class="hl-0"> </span><span class="hl-6">type</span><span class="hl-0"> </span><span class="hl-7">Coordinates</span><span class="hl-0"> = [</span><span class="hl-13">latitude</span><span class="hl-0">: </span><span class="hl-7">number</span><span class="hl-0">, </span><span class="hl-13">length</span><span class="hl-0">: </span><span class="hl-7">number</span><span class="hl-0">];</span>
</code></pre>
<p>Estos se corresponden a los usados en la práctica anterior de <strong>Destravate</strong>.</p>

<a href="#middlewares" id="middlewares" style="color: inherit; text-decoration: none;">
  <h2>Middlewares</h2>
</a>
<p>Nos parece interesante comentar que nos aventuramos a estudiar el funcionamiento de los middlewares de Mongoose. Estos se ejecutan antes de que se ejecute una determinada función. En nuestro caso, nos interesaba que se ejecutara antes de que se ejecutara la función <strong>save</strong> de un modelo de mongoose. Para ello, utilizamos la función <strong>pre</strong> de mongoose. Esta función recibe dos parámetros: el primero es el nombre de la función que se quiere ejecutar y el segundo es la función que se quiere ejecutar. En nuestro caso, queremos ejecutar la función <strong>save</strong> y la función que se va a ejecutar es la siguiente:</p>
<pre><code class="language-typescript"><br/><span class="hl-1">UserSchema</span><span class="hl-0">.</span><span class="hl-3">pre</span><span class="hl-0">(</span><span class="hl-4">&#39;save&#39;</span><span class="hl-0">, </span><span class="hl-6">function</span><span class="hl-0">(</span><span class="hl-1">next</span><span class="hl-0">) {  </span><br/><span class="hl-0">  </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">contador</span><span class="hl-0"> = </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Map</span><span class="hl-0">&lt;</span><span class="hl-7">string</span><span class="hl-0">, </span><span class="hl-7">number</span><span class="hl-0">&gt;();</span><br/><span class="hl-0">  </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">    </span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0">.</span><span class="hl-3">forEach</span><span class="hl-0">((</span><span class="hl-1">value</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">      </span><span class="hl-5">for</span><span class="hl-0"> (</span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">i</span><span class="hl-0"> = </span><span class="hl-12">0</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0"> &lt; </span><span class="hl-1">value</span><span class="hl-0">.</span><span class="hl-1">length</span><span class="hl-0">; </span><span class="hl-1">i</span><span class="hl-0">++) {</span><br/><span class="hl-0">        </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">contador</span><span class="hl-0">.</span><span class="hl-3">has</span><span class="hl-0">(</span><span class="hl-1">value</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">].</span><span class="hl-3">toString</span><span class="hl-0">()) &amp;&amp; </span><span class="hl-1">contador</span><span class="hl-0">.</span><span class="hl-3">get</span><span class="hl-0">(</span><span class="hl-1">value</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">].</span><span class="hl-3">toString</span><span class="hl-0">()) !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">          </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">actual</span><span class="hl-0"> = </span><span class="hl-1">contador</span><span class="hl-0">.</span><span class="hl-3">get</span><span class="hl-0">(</span><span class="hl-1">value</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">].</span><span class="hl-3">toString</span><span class="hl-0">());</span><br/><span class="hl-0">          </span><span class="hl-5">if</span><span class="hl-0"> (</span><span class="hl-1">actual</span><span class="hl-0"> !== </span><span class="hl-6">undefined</span><span class="hl-0">) {</span><br/><span class="hl-0">            </span><span class="hl-1">contador</span><span class="hl-0">.</span><span class="hl-3">set</span><span class="hl-0">(</span><span class="hl-1">value</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">].</span><span class="hl-3">toString</span><span class="hl-0">(), </span><span class="hl-1">actual</span><span class="hl-0"> + </span><span class="hl-12">1</span><span class="hl-0">);</span><br/><span class="hl-0">          }</span><br/><span class="hl-0">        } </span><span class="hl-5">else</span><span class="hl-0"> {</span><br/><span class="hl-0">          </span><span class="hl-1">contador</span><span class="hl-0">.</span><span class="hl-3">set</span><span class="hl-0">(</span><span class="hl-1">value</span><span class="hl-0">[</span><span class="hl-1">i</span><span class="hl-0">].</span><span class="hl-3">toString</span><span class="hl-0">(), </span><span class="hl-12">1</span><span class="hl-0">);</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">      } </span><br/><span class="hl-0">    });</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">  </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">ordenado</span><span class="hl-0"> = </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-3">Map</span><span class="hl-0">([...</span><span class="hl-1">contador</span><span class="hl-0">.</span><span class="hl-3">entries</span><span class="hl-0">()].</span><span class="hl-3">sort</span><span class="hl-0">((</span><span class="hl-1">a</span><span class="hl-0">, </span><span class="hl-1">b</span><span class="hl-0">) </span><span class="hl-6">=&gt;</span><span class="hl-0"> </span><span class="hl-1">b</span><span class="hl-0">[</span><span class="hl-12">1</span><span class="hl-0">] - </span><span class="hl-1">a</span><span class="hl-0">[</span><span class="hl-12">1</span><span class="hl-0">]));</span><br/><span class="hl-0">  </span><span class="hl-5">for</span><span class="hl-0"> (</span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">key</span><span class="hl-0"> </span><span class="hl-6">of</span><span class="hl-0"> </span><span class="hl-1">ordenado</span><span class="hl-0">.</span><span class="hl-3">keys</span><span class="hl-0">()) {</span><br/><span class="hl-0">    </span><span class="hl-6">this</span><span class="hl-0">.</span><span class="hl-1">favoriteTracks</span><span class="hl-0">?.</span><span class="hl-3">push</span><span class="hl-0">((</span><span class="hl-1">key</span><span class="hl-0"> </span><span class="hl-5">as</span><span class="hl-0"> </span><span class="hl-7">unknown</span><span class="hl-0">) </span><span class="hl-5">as</span><span class="hl-0"> </span><span class="hl-7">Schema</span><span class="hl-0">.</span><span class="hl-7">Types</span><span class="hl-0">.</span><span class="hl-7">ObjectId</span><span class="hl-0">);</span><br/><span class="hl-0">  }</span><br/><span class="hl-0">  </span><span class="hl-3">next</span><span class="hl-0">();</span><br/><span class="hl-0">});</span>
</code></pre>
<p>Gracias a este Middleware, podemos actualizar el atributo <strong>favoriteTracks</strong> de un usuario cada vez que se ejecute la función <strong>save</strong>. Para ello, utilizamos un <strong>Map</strong> que se encarga de contar las apariciones de cada <strong>id</strong> de una ruta en el atributo <strong>history</strong> de un usuario. Una vez que tenemos el <strong>Map</strong> ordenado, actualizamos el atributo <strong>favoriteTracks</strong> con las <strong>id</strong> de las rutas que más veces han aparecido en el atributo <strong>history</strong> de un usuario.</p>

<a href="#tests" id="tests" style="color: inherit; text-decoration: none;">
  <h2>Tests</h2>
</a>
<p>Para poder llevar a cabo los test de la aplicación sin la necesidad de tener el servidor en funcionamiento, hemos utilizado la librería <strong>supertest</strong>. Para ello, seguimos las refactorizaciones de código propuestas en <a href="https://ull-esit-inf-dsi-2223.github.io/nodejs-theory/nodejs-rest-api-testing.html">los apuntes de la asignatura</a>.</p>
<p>Si se sigue correctamente los pasos de los apuntes, se debería conseguir una base de datos exclusiva para los test. Por último debemos tener presente que para los test usaremos <strong>async/await</strong> en lugar de <strong>done</strong>. Además de <strong>request</strong> de <strong>supertest</strong>.</p>
<p>Posteriormente los test hemos decidido hacer una serie de casos de uso donde se presentaran todo tipo de operaciones para poder evaluar de la mejor forma a nuestra API. Cabe destacar que hicimos uso del operador <strong>before</strong> que nos ofrece <strong>mocha</strong> para limpiar la base de datos antes de empezar a desarrollar los test. De esta forma nos aseguramos arrancar siempre con una base de datos limpia y sin datos que puedan interferir en los test.</p>
<p>Podemos ver algunos ejemplos de estos test a continuación:</p>
<pre><code class="language-typescript"><span class="hl-3">describe</span><span class="hl-0">(</span><span class="hl-4">&#39;POST /users&#39;</span><span class="hl-0">, () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">  </span><span class="hl-3">it</span><span class="hl-0">(</span><span class="hl-4">&#39;Un usuario se crea con los parámetros mínimos correctamente&#39;</span><span class="hl-0">, </span><span class="hl-6">async</span><span class="hl-0"> () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">ruta</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-3">request</span><span class="hl-0">(</span><span class="hl-1">app</span><span class="hl-0">).</span><span class="hl-3">post</span><span class="hl-0">(</span><span class="hl-4">&#39;/tracks&#39;</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">({</span><br/><span class="hl-0">      </span><span class="hl-1">id:</span><span class="hl-0"> </span><span class="hl-12">1</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-4">&quot;RutaFondoBiKini&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">startGeolocation:</span><span class="hl-0"> [</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">],</span><br/><span class="hl-0">      </span><span class="hl-1">endGeolocation:</span><span class="hl-0"> [</span><span class="hl-12">1</span><span class="hl-0">,</span><span class="hl-12">1</span><span class="hl-0">],</span><br/><span class="hl-0">      </span><span class="hl-1">distance:</span><span class="hl-0"> </span><span class="hl-12">3</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">unevenness:</span><span class="hl-0"> </span><span class="hl-12">4</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">activity:</span><span class="hl-0"> </span><span class="hl-4">&quot;Correr&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">users:</span><span class="hl-0"> []</span><br/><span class="hl-0">    });</span><br/><span class="hl-0">    </span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">response</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-3">request</span><span class="hl-0">(</span><span class="hl-1">app</span><span class="hl-0">).</span><span class="hl-3">post</span><span class="hl-0">(</span><span class="hl-4">&#39;/users&#39;</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">({</span><br/><span class="hl-0">      </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-4">&quot;Bob Esponja&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-4">&quot;bobesponja&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">history:</span><span class="hl-0"> {</span><span class="hl-4">&quot;01-01-2023&quot;</span><span class="hl-1">:</span><span class="hl-0"> [</span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0">]}</span><br/><span class="hl-0">    }).</span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-12">201</span><span class="hl-0">);</span><br/><span class="hl-0">    </span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">include</span><span class="hl-0">({</span><br/><span class="hl-0">      </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-4">&#39;Bob Esponja&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-4">&#39;bobesponja&#39;</span><br/><span class="hl-0">    });</span><br/><span class="hl-0">    </span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">checkFirstUser</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findById</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0">);</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">checkFirstUser</span><span class="hl-0">).</span><span class="hl-1">not</span><span class="hl-0">.</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-1">be</span><span class="hl-0">.</span><span class="hl-1">null</span><span class="hl-0">;</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">checkFirstUser</span><span class="hl-0">!.</span><span class="hl-1">username</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">equal</span><span class="hl-0">(</span><span class="hl-4">&#39;bobesponja&#39;</span><span class="hl-0">);   </span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-1">deep</span><span class="hl-0">.</span><span class="hl-3">equal</span><span class="hl-0">({</span><span class="hl-4">&quot;01-01-2023&quot;</span><span class="hl-1">:</span><span class="hl-0"> [</span><span class="hl-1">ruta</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0">]});</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">trainingStats</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">eql</span><span class="hl-0">([[</span><span class="hl-12">4</span><span class="hl-0">,</span><span class="hl-12">3</span><span class="hl-0">], [</span><span class="hl-12">4</span><span class="hl-0">,</span><span class="hl-12">3</span><span class="hl-0">], [</span><span class="hl-12">4</span><span class="hl-0">,</span><span class="hl-12">3</span><span class="hl-0">]]);</span><br/><span class="hl-0">  });</span><br/><br/><span class="hl-0">  </span><span class="hl-3">it</span><span class="hl-0">(</span><span class="hl-4">&#39;Si se intenta crear un nuevo usuario con el mismo username falla&#39;</span><span class="hl-0">, </span><span class="hl-6">async</span><span class="hl-0"> () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">response</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-3">request</span><span class="hl-0">(</span><span class="hl-1">app</span><span class="hl-0">).</span><span class="hl-3">post</span><span class="hl-0">(</span><span class="hl-4">&#39;/users&#39;</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">({</span><br/><span class="hl-0">      </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-4">&quot;Bob Esponja&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-4">&quot;bobesponja&quot;</span><br/><span class="hl-0">    }).</span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-12">500</span><span class="hl-0">);</span><br/><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">checkFirstUser</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findById</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0">);</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">checkFirstUser</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-1">be</span><span class="hl-0">.</span><span class="hl-1">null</span><span class="hl-0">;</span><br/><span class="hl-0">  });</span><br/><br/><span class="hl-0">  </span><span class="hl-3">it</span><span class="hl-0">(</span><span class="hl-4">&#39;Un usuario se crea con los parámetros mínimos correctamente&#39;</span><span class="hl-0">, </span><span class="hl-6">async</span><span class="hl-0"> () </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">BobEsponja</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findOne</span><span class="hl-0">({</span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-4">&#39;bobesponja&#39;</span><span class="hl-0">});</span><br/><span class="hl-0">    </span><span class="hl-6">let</span><span class="hl-0"> </span><span class="hl-1">idBobEsponja</span><span class="hl-0"> = </span><span class="hl-4">&quot;&quot;</span><span class="hl-0">;</span><br/><span class="hl-0">    </span><span class="hl-5">if</span><span class="hl-0">(</span><span class="hl-1">BobEsponja</span><span class="hl-0"> !== </span><span class="hl-6">null</span><span class="hl-0">) {</span><br/><span class="hl-0">      </span><span class="hl-1">idBobEsponja</span><span class="hl-0"> = </span><span class="hl-1">BobEsponja</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0">.</span><span class="hl-3">toString</span><span class="hl-0">();</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">response</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-3">request</span><span class="hl-0">(</span><span class="hl-1">app</span><span class="hl-0">).</span><span class="hl-3">post</span><span class="hl-0">(</span><span class="hl-4">&#39;/users&#39;</span><span class="hl-0">).</span><span class="hl-3">send</span><span class="hl-0">({</span><br/><span class="hl-0">      </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-4">&quot;Patricio Estrella&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-4">&quot;patricio&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">activity:</span><span class="hl-0"> </span><span class="hl-4">&quot;Bicicleta&quot;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">friends:</span><span class="hl-0"> [</span><span class="hl-1">idBobEsponja</span><span class="hl-0">],</span><br/><span class="hl-0">    }).</span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-12">201</span><span class="hl-0">);</span><br/><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">include</span><span class="hl-0">({</span><br/><span class="hl-0">      </span><span class="hl-1">name:</span><span class="hl-0"> </span><span class="hl-4">&#39;Patricio Estrella&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">username:</span><span class="hl-0"> </span><span class="hl-4">&#39;patricio&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">      </span><span class="hl-1">activity:</span><span class="hl-0"> </span><span class="hl-4">&#39;Bicicleta&#39;</span><br/><span class="hl-0">    });</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">friends</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">eql</span><span class="hl-0">([</span><span class="hl-1">idBobEsponja</span><span class="hl-0">]);</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">friendsGroups</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">eql</span><span class="hl-0">([]);</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">trainingStats</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">eql</span><span class="hl-0">([[</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">], [</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">], [</span><span class="hl-12">0</span><span class="hl-0">,</span><span class="hl-12">0</span><span class="hl-0">]]);</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">favoriteTracks</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">eql</span><span class="hl-0">([]);</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">favoriteChallenges</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">eql</span><span class="hl-0">([]);</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">Array</span><span class="hl-0">.</span><span class="hl-3">from</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">history</span><span class="hl-0">)).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-1">deep</span><span class="hl-0">.</span><span class="hl-3">equal</span><span class="hl-0">([]);</span><br/><br/><span class="hl-0">  </span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-8">checkFirstUser</span><span class="hl-0"> = </span><span class="hl-5">await</span><span class="hl-0"> </span><span class="hl-1">User</span><span class="hl-0">.</span><span class="hl-3">findById</span><span class="hl-0">(</span><span class="hl-1">response</span><span class="hl-0">.</span><span class="hl-1">body</span><span class="hl-0">.</span><span class="hl-1">_id</span><span class="hl-0">);</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">checkFirstUser</span><span class="hl-0">).</span><span class="hl-1">not</span><span class="hl-0">.</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-1">be</span><span class="hl-0">.</span><span class="hl-1">null</span><span class="hl-0">;</span><br/><span class="hl-0">    </span><span class="hl-3">expect</span><span class="hl-0">(</span><span class="hl-1">checkFirstUser</span><span class="hl-0">!.</span><span class="hl-1">username</span><span class="hl-0">).</span><span class="hl-1">to</span><span class="hl-0">.</span><span class="hl-3">equal</span><span class="hl-0">(</span><span class="hl-4">&#39;patricio&#39;</span><span class="hl-0">);</span><br/><span class="hl-0">  });</span><br/><span class="hl-0">});</span>
</code></pre>

<a href="#conclusiones" id="conclusiones" style="color: inherit; text-decoration: none;">
  <h2>Conclusiones</h2>
</a>
<p>Sin duda alguna es una alegría terminar el proyecto con éxito. La asignatura de DSI ha sido toda una experiencia para nosotros, donde hemos aprendido una gran cantidad de herramientas e ideas de desarrollo. Después de hablarlo mucho, consideramos que es la asignatura que más conocimientos previos requiere, pero a su vez es la que más conocienminetos te aporta. </p>
<p>Tras un cuatrimestre de apreduzaje debemos reconocer que es la asignatura que más nos ha gustado y que más nos ha aportado. De cierta forma, nos demuestra lo mucho que nos falta para salir al sector laborar, pero a la vez nos demuestra lo amueblada que tenemos la cabeza de cientos de conceptos.</p>
<p>La práctica como tal ha sido bastante agradable y nos ha obligado en muchas ocasiones a tomar papel y lapz y modelar todas las relaciones y direcciones que tomaba y consideramos que ese proceso es el que nos diferencia de los alumnos que eramos en primer año.</p>
<p>Por último, nos gustaría agradecer a los profesores de la asignatura por su dedicación y por su esfuerzo en hacer la asignatura tan interesante y amena. Aplaudimos el hecho de no plantear un aburrido examen final y en su lugar recompenzar el trabajo y esfuerzo que ha requerido la asignatura a lo largo del cuatrimestre.</p>

<a href="#referencias" id="referencias" style="color: inherit; text-decoration: none;">
  <h2>Referencias</h2>
</a>
<ul>
<li><p><a href="https://ull-esit-inf-dsi-2223.github.io/nodejs-theory/nodejs-mongodb.html">MongoDB</a></p>
</li>
<li><p><a href="https://ull-esit-inf-dsi-2223.github.io/nodejs-theory/nodejs-mongoose.html">Mongoose</a></p>
</li>
<li><p><a href="https://ull-esit-inf-dsi-2223.github.io/nodejs-theory/nodejs-rest-api.html">API REST</a></p>
</li>
<li><p><a href="https://ull-esit-inf-dsi-2223.github.io/nodejs-theory/nodejs-rest-api-testing.html">SuperTest</a></p>
</li>
</ul>
</div></div>
<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
<div class="tsd-navigation settings">
<details class="tsd-index-accordion"><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Settings</h3></summary>
<div class="tsd-accordion-details">
<div class="tsd-filter-visibility">
<h4 class="uppercase">Member Visibility</h4><form>
<ul id="tsd-filter-options">
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-private" name="private"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Private</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></form></div>
<div class="tsd-theme-toggle">
<h4 class="uppercase">Theme</h4><select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div>
<nav class="tsd-navigation primary">
<details class="tsd-index-accordion" open><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Modules</h3></summary>
<div class="tsd-accordion-details">
<ul>
<li class="current selected"><a href="modules.html">Practica12</a>
<ul>
<li class="tsd-kind-module"><a href="modules/app.html">app</a></li>
<li class="tsd-kind-module"><a href="modules/db_mongoose.html">db/mongoose</a></li>
<li class="tsd-kind-module"><a href="modules/index.html">index</a></li>
<li class="tsd-kind-module"><a href="modules/index-1.html">index</a></li>
<li class="tsd-kind-module"><a href="modules/models_challengeModel.html">models/challenge<wbr/>Model</a></li>
<li class="tsd-kind-module"><a href="modules/models_groupModel.html">models/group<wbr/>Model</a></li>
<li class="tsd-kind-module"><a href="modules/models_trackModel.html">models/track<wbr/>Model</a></li>
<li class="tsd-kind-module"><a href="modules/models_userModel.html">models/user<wbr/>Model</a></li>
<li class="tsd-kind-module"><a href="modules/routers_challenge_delete.html">routers/challenge/delete</a></li>
<li class="tsd-kind-module"><a href="modules/routers_challenge_get.html">routers/challenge/get</a></li>
<li class="tsd-kind-module"><a href="modules/routers_challenge_patch.html">routers/challenge/patch</a></li>
<li class="tsd-kind-module"><a href="modules/routers_challenge_post.html">routers/challenge/post</a></li>
<li class="tsd-kind-module"><a href="modules/routers_challengeRouter.html">routers/challenge<wbr/>Router</a></li>
<li class="tsd-kind-module"><a href="modules/routers_defaultRouter.html">routers/default<wbr/>Router</a></li>
<li class="tsd-kind-module"><a href="modules/routers_group_delete.html">routers/group/delete</a></li>
<li class="tsd-kind-module"><a href="modules/routers_group_get.html">routers/group/get</a></li>
<li class="tsd-kind-module"><a href="modules/routers_group_patch.html">routers/group/patch</a></li>
<li class="tsd-kind-module"><a href="modules/routers_group_post.html">routers/group/post</a></li>
<li class="tsd-kind-module"><a href="modules/routers_groupRouter.html">routers/group<wbr/>Router</a></li>
<li class="tsd-kind-module"><a href="modules/routers_track_delete.html">routers/track/delete</a></li>
<li class="tsd-kind-module"><a href="modules/routers_track_get.html">routers/track/get</a></li>
<li class="tsd-kind-module"><a href="modules/routers_track_patch.html">routers/track/patch</a></li>
<li class="tsd-kind-module"><a href="modules/routers_track_post.html">routers/track/post</a></li>
<li class="tsd-kind-module"><a href="modules/routers_trackRouter.html">routers/track<wbr/>Router</a></li>
<li class="tsd-kind-module"><a href="modules/routers_user_delete.html">routers/user/delete</a></li>
<li class="tsd-kind-module"><a href="modules/routers_user_get.html">routers/user/get</a></li>
<li class="tsd-kind-module"><a href="modules/routers_user_patch.html">routers/user/patch</a></li>
<li class="tsd-kind-module"><a href="modules/routers_user_post.html">routers/user/post</a></li>
<li class="tsd-kind-module"><a href="modules/routers_userRouter.html">routers/user<wbr/>Router</a></li>
<li class="tsd-kind-module"><a href="modules/tools_tools.html">tools/tools</a></li>
<li class="tsd-kind-module"><a href="modules/types_type.html">types/type</a></li></ul></li></ul></div></details></nav></div></div>
<div class="container tsd-generator">
<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div>
<div class="overlay"></div><script src="assets/main.js"></script></body></html>